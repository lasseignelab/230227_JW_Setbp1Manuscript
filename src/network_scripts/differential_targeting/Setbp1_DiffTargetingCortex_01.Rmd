---
title: "Setbp1_DiffTargetingCortex_01"
output: html_document
date: '2023-02-13'
---

This R markdown script is a reanalysis of the gene targeting analysis performed in "Setbp1_AllCortex_PANDAComparison_01.Rmd" in order to determine the impact of edge weight on the gene/TF targeting scores from the regulatory networks. In an effort to determine this, all networks below were filtered to only include positive weights, whereas in the previous script both positives and negatives were included. 

Targeting code was originially implemented here: http://netbooks.networkmedicine.org/user/b04f15be-cbd3-44df-932f-6e9026018fd0/notebooks/netZooR/lioness_tcga_targeting_netbook.ipynb

#load in required libraries & functions
```{r loading-libraries-functions, results='hide'}
set.seed(2178)
library(netZooR)
library(data.table)
library(dplyr)
library(limma)
library(tidyr)
library(ggpubr)
library(ggplot2)
library(ComplexHeatmap)
library(RColorBrewer)
library(magrittr)
library(circlize)
library(readr)
library(gprofiler2)
library(here)
source(here("src/functions/functions.R"))
library(styler)
library(lintr)
```

## load in PANDA object containing list of all cell types from Setbp1 data
Here each item returned by the for loop represents a PANDA object for a given cell type that contains the regNet, coopNet, and coregNet for that cell type.
```{r loading-object, results='hide'}
files <- list.files(here("results/PANDA"), pattern = "cortexexpression_PANDA.Rdata", full.names = TRUE) #grabbing cortex samples
for (i in files){
 load(i)
  regNet <- pandaResults
  regNet <- regNet@regNet
  name <- sub(here("results/PANDA/"), "", i)
  name <- sub("cortexexpression_PANDA.Rdata*", "", name)
  assign(paste0(name, ".regNet" ), regNet)
  rm(pandaResults)
  rm(regNet)
}
```

## Visualizing edge weight distributions filtered and unfiltered
```{r visualize-distribution-of-unfiltered-het-regNet-scores}
oligodendrocytes.melt <- as.data.frame(melt(oligodendrocytes.heterozygous.regNet, varnames = c("TF", "gene"), value.name = "het_edge_weight"))#melting dataframe
oligodendrocytes.melt <- as.data.frame(oligodendrocytes.melt[,3])
colnames(oligodendrocytes.melt) <- "edge_weight"
oligodendrocytes.melt$cell_type <- "oligodendrocytes"

astrocytes.melt <- as.data.frame(melt(astrocytes.heterozygous.regNet, varnames = c("TF", "gene"), value.name = "het_edge_weight"))#melting dataframe
astrocytes.melt <- as.data.frame(astrocytes.melt[,3])
colnames(astrocytes.melt) <- "edge_weight"
astrocytes.melt$cell_type <- "astrocytes"

mural.melt <- as.data.frame(melt(mural.heterozygous.regNet, varnames = c("TF", "gene"), value.name = "het_edge_weight"))#melting dataframe
mural.melt <- as.data.frame(mural.melt[,3])
colnames(mural.melt) <- "edge_weight"
mural.melt$cell_type <- "mural"

opcs.melt <- as.data.frame(melt(opcs.heterozygous.regNet, varnames = c("TF", "gene"), value.name = "het_edge_weight"))#melting dataframe
opcs.melt <- as.data.frame(opcs.melt[,3])
colnames(opcs.melt) <- "edge_weight"
opcs.melt$cell_type <- "opcs"

microglia.melt <- as.data.frame(melt(microglia.heterozygous.regNet, varnames = c("TF", "gene"), value.name = "het_edge_weight"))#melting dataframe
microglia.melt <- as.data.frame(microglia.melt[,3])
colnames(microglia.melt) <- "edge_weight"
microglia.melt$cell_type <- "microglia"

inhibitory.neurons.melt <- as.data.frame(melt(inhibitory.neurons.heterozygous.regNet, varnames = c("TF", "gene"), value.name = "het_edge_weight"))#melting dataframe
inhibitory.neurons.melt <- as.data.frame(inhibitory.neurons.melt[,3])
colnames(inhibitory.neurons.melt) <- "edge_weight"
inhibitory.neurons.melt$cell_type <- "inhibitory.neurons"

excitatory.neurons.melt <- as.data.frame(melt(excitatory.neurons.heterozygous.regNet, varnames = c("TF", "gene"), value.name = "het_edge_weight"))#melting dataframe
excitatory.neurons.melt <- as.data.frame(excitatory.neurons.melt[,3])
colnames(excitatory.neurons.melt) <- "edge_weight"
excitatory.neurons.melt$cell_type <- "excitatory.neurons"

fibro.melt <- as.data.frame(melt(fibro_cortex.heterozygous.regNet, varnames = c("TF", "gene"), value.name = "het_edge_weight"))#melting dataframe
fibro.melt <- as.data.frame(fibro.melt[,3])
colnames(fibro.melt) <- "edge_weight"
fibro.melt$cell_type <- "fibro"

merged <- bind_rows(mural.melt, microglia.melt, opcs.melt, excitatory.neurons.melt, inhibitory.neurons.melt, oligodendrocytes.melt, astrocytes.melt, fibro.melt)

png(filename = here("results/diff_targeting/cortex_regNet_edgeweight_dist_het.png"),
    width = 1000,
    height = 500)
ggplot(data=merged, aes(x=edge_weight, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Distribution of regNet edge weights in S858R Cerebral Cortex") + theme_bw() + scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB", "#C216B7","#027461" ,"#7997FF", "#00C1AA"))
dev.off()
```

```{r visualize-distribution-of-unfiltered-ctrl-regNet-scores}
oligodendrocytes.melt <- as.data.frame(melt(oligodendrocytes.control.regNet, varnames = c("TF", "gene"), value.name = "ctrl_edge_weight"))#melting dataframe
oligodendrocytes.melt <- as.data.frame(oligodendrocytes.melt[,3])
colnames(oligodendrocytes.melt) <- "edge_weight"
oligodendrocytes.melt$cell_type <- "oligodendrocytes"

astrocytes.melt <- as.data.frame(melt(astrocytes.control.regNet, varnames = c("TF", "gene"), value.name = "ctrl_edge_weight"))#melting dataframe
astrocytes.melt <- as.data.frame(astrocytes.melt[,3])
colnames(astrocytes.melt) <- "edge_weight"
astrocytes.melt$cell_type <- "astrocytes"

mural.melt <- as.data.frame(melt(mural.control.regNet, varnames = c("TF", "gene"), value.name = "ctrl_edge_weight"))#melting dataframe
mural.melt <- as.data.frame(mural.melt[,3])
colnames(mural.melt) <- "edge_weight"
mural.melt$cell_type <- "mural"

opcs.melt <- as.data.frame(melt(opcs.control.regNet, varnames = c("TF", "gene"), value.name = "ctrl_edge_weight"))#melting dataframe
opcs.melt <- as.data.frame(opcs.melt[,3])
colnames(opcs.melt) <- "edge_weight"
opcs.melt$cell_type <- "opcs"

microglia.melt <- as.data.frame(melt(microglia.control.regNet, varnames = c("TF", "gene"), value.name = "ctrl_edge_weight"))#melting dataframe
microglia.melt <- as.data.frame(microglia.melt[,3])
colnames(microglia.melt) <- "edge_weight"
microglia.melt$cell_type <- "microglia"

inhibitory.neurons.melt <- as.data.frame(melt(inhibitory.neurons.control.regNet, varnames = c("TF", "gene"), value.name = "ctrl_edge_weight"))#melting dataframe
inhibitory.neurons.melt <- as.data.frame(inhibitory.neurons.melt[,3])
colnames(inhibitory.neurons.melt) <- "edge_weight"
inhibitory.neurons.melt$cell_type <- "inhibitory.neurons"

excitatory.neurons.melt <- as.data.frame(melt(excitatory.neurons.control.regNet, varnames = c("TF", "gene"), value.name = "ctrl_edge_weight"))#melting dataframe
excitatory.neurons.melt <- as.data.frame(excitatory.neurons.melt[,3])
colnames(excitatory.neurons.melt) <- "edge_weight"
excitatory.neurons.melt$cell_type <- "excitatory.neurons"

fibro.melt <- as.data.frame(melt(fibro_cortex.control.regNet, varnames = c("TF", "gene"), value.name = "ctrl_edge_weight"))#melting dataframe
fibro.melt <- as.data.frame(fibro.melt[,3])
colnames(fibro.melt) <- "edge_weight"
fibro.melt$cell_type <- "fibro"

merged <- bind_rows(mural.melt, microglia.melt, opcs.melt, excitatory.neurons.melt, inhibitory.neurons.melt, oligodendrocytes.melt, astrocytes.melt, fibro.melt)

png(filename = here("results/diff_targeting/cortex_regNet_edgeweight_dist_ctrl.png"),
    width = 1000,
    height = 500)
ggplot(data=merged, aes(x=edge_weight, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Distribution of regNet edge weights in control Cerebral Cortex") + theme_bw() + scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB","#C216B7","#027461","#7997FF","#00C1AA"))
dev.off()
```

Note: all negative edge weights were changed to 0
```{r visualize-distribution-of-filtered-het-regNet-scores}
astro <- as.data.frame(astrocytes.heterozygous.regNet[,3]) 
astro$cell_type <- "astrocytes"
colnames(astro) <- c("edge_weight", "cell_type")
astro <- astro[astro$edge_weight > 0,]

oligo <- as.data.frame(oligodendrocytes.heterozygous.regNet[,3]) 
oligo$cell_type <- "oligodendrocyte"
colnames(oligo) <- c("edge_weight", "cell_type")
oligo <- oligo[oligo$edge_weight > 0,]

inhibitory <- as.data.frame(inhibitory.neurons.heterozygous.regNet[,3]) 
inhibitory$cell_type <- "inhibitory"
colnames(inhibitory) <- c("edge_weight", "cell_type")
inhibitory <- inhibitory[inhibitory$edge_weight > 0,]

excitatory<- as.data.frame(excitatory.neurons.heterozygous.regNet[,3]) 
excitatory$cell_type <- "excitatory"
colnames(excitatory) <- c("edge_weight", "cell_type")
excitatory <- excitatory[excitatory$edge_weight > 0,]

opcs <- as.data.frame(opcs.heterozygous.regNet[,3]) 
opcs$cell_type <- "opcs"
colnames(opcs) <- c("edge_weight", "cell_type")
opcs <- opcs[opcs$edge_weight > 0,]

micro <- as.data.frame(microglia.heterozygous.regNet[,3]) 
micro$cell_type <- "microglia"
colnames(micro) <- c("edge_weight", "cell_type")
micro <- micro[micro$edge_weight > 0,]

mural <- as.data.frame(mural.heterozygous.regNet[,3])
mural$cell_type <- "mural"
colnames(mural) <- c("edge_weight", "cell_type")
mural <- mural[mural$edge_weight > 0,]

fibro <- as.data.frame(fibro_cortex.heterozygous.regNet[,3])
fibro$cell_type <- "fibro"
colnames(fibro) <- c("edge_weight", "cell_type")
fibro <- fibro[fibro$edge_weight > 0,]

merged <- bind_rows(mural, micro, opcs, excitatory, inhibitory, oligo, astro, fibro)

png(filename = here("results/diff_targeting/cortex_regNet_edgeweight_filtered_dist_het.png"),
    width = 1000,
    height = 500)
ggplot(data=merged, aes(x=edge_weight, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Distribution of regNet edge weights > 0 in S858R Cerebral Cortex") + theme_bw() + scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB","#C216B7","#027461","#7997FF","#00C1AA"))
dev.off()
```

```{r visualize-distribution-of-filtered-ctrl-regNet-scores}
astro <- as.data.frame(astrocytes.control.regNet[,3]) 
astro$cell_type <- "astrocytes"
colnames(astro) <- c("edge_weight", "cell_type")
astro <- astro[astro$edge_weight > 0,]

oligo <- as.data.frame(oligodendrocytes.control.regNet[,3]) 
oligo$cell_type <- "oligodendrocyte"
colnames(oligo) <- c("edge_weight", "cell_type")
oligo <- oligo[oligo$edge_weight > 0,]

inhibitory <- as.data.frame(inhibitory.neurons.control.regNet[,3]) 
inhibitory$cell_type <- "inhibitory"
colnames(inhibitory) <- c("edge_weight", "cell_type")
inhibitory <- inhibitory[inhibitory$edge_weight > 0,]

excitatory<- as.data.frame(excitatory.neurons.control.regNet[,3]) 
excitatory$cell_type <- "excitatory"
colnames(excitatory) <- c("edge_weight", "cell_type")
excitatory <- excitatory[excitatory$edge_weight > 0,]

opcs <- as.data.frame(opcs.control.regNet[,3]) 
opcs$cell_type <- "opcs"
colnames(opcs) <- c("edge_weight", "cell_type")
opcs <- opcs[opcs$edge_weight > 0,]

micro <- as.data.frame(microglia.control.regNet[,3]) 
micro$cell_type <- "microglia"
colnames(micro) <- c("edge_weight", "cell_type")
micro <- micro[micro$edge_weight > 0,]

mural <- as.data.frame(mural.control.regNet[,3])
mural$cell_type <- "mural"
colnames(mural) <- c("edge_weight", "cell_type")
mural <- mural[mural$edge_weight > 0,]

fibro <- as.data.frame(fibro_cortex.control.regNet[,3])
fibro$cell_type <- "fibro"
colnames(fibro) <- c("edge_weight", "cell_type")
fibro <- fibro[fibro$edge_weight > 0,]

merged <- bind_rows(mural, micro, opcs, excitatory, inhibitory, oligo, astro, fibro)

png(filename = here("results/diff_targeting/cortex_regNet_edgeweight_filtered_dist_ctrl.png"),
    width = 1000,
    height = 500)
ggplot(data=merged, aes(x=edge_weight, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Distribution of regNet edge weights >0 in control Cerebral Cortex") + theme_bw() + scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB","#C216B7","#027461","#7997FF","#00C1AA"))
dev.off()
```

## wrangling data to proper format, filtering for only positive edge weights, and calculating targeting scores:
Gene targeting score, a numerical score representing the extent to which a gene is targeted by TFs in a given biological context. The gene targeting score is calculated by summing the weights of all inbound regulatory edges for a gene or outbound edges for a TF (https://doi.org/10.3389/fgene.2021.649942). 
* regNetmatrix: The PANDA regNet output matrix of TF and Genes and their edge weights from running pandaR 
* variable_name: Here this is the cell type, or variable you would like the targeting score matrix stored as in your global environment 
* edge_weight_name: This is the name of the edge_weight column in your matrix (options: het_edge_weight, ctrl_edge_weight)
* condition: The group the data is from, in this instance it is ctrl or het.

```{r calc-targeting}
#astro targeting
targetingCalc(regNetmatrix = astrocytes.control.regNet, variable_name = "astro", edge_weight_name = ctrl_edge_weight, condition = "ctrl")
targetingCalc(regNetmatrix = astrocytes.heterozygous.regNet, variable_name = "astro", edge_weight_name = het_edge_weight, condition = "het")
#micro
targetingCalc(regNetmatrix = microglia.control.regNet, variable_name = "micro", edge_weight_name = ctrl_edge_weight, condition = "ctrl")
targetingCalc(regNetmatrix = microglia.heterozygous.regNet, variable_name = "micro", edge_weight_name = het_edge_weight, condition = "het")
#fibro
targetingCalc(regNetmatrix = fibro_cortex.control.regNet, variable_name = "fibro", edge_weight_name = ctrl_edge_weight, condition = "ctrl")
targetingCalc(regNetmatrix = fibro_cortex.heterozygous.regNet, variable_name = "fibro", edge_weight_name = het_edge_weight, condition = "het")
#excitatory
targetingCalc(regNetmatrix = excitatory.neurons.control.regNet, variable_name = "excitatory", edge_weight_name = ctrl_edge_weight, condition = "ctrl")
targetingCalc(regNetmatrix = excitatory.neurons.heterozygous.regNet, variable_name = "excitatory", edge_weight_name = het_edge_weight, condition = "het")
#inhibitory
targetingCalc(regNetmatrix = inhibitory.neurons.control.regNet, variable_name = "inhibitory", edge_weight_name = ctrl_edge_weight, condition = "ctrl")
targetingCalc(regNetmatrix = inhibitory.neurons.heterozygous.regNet, variable_name = "inhibitory", edge_weight_name = het_edge_weight, condition = "het")
#mural
targetingCalc(regNetmatrix = mural.control.regNet, variable_name = "mural", edge_weight_name = ctrl_edge_weight, condition = "ctrl")
targetingCalc(regNetmatrix = mural.heterozygous.regNet, variable_name = "mural", edge_weight_name = het_edge_weight, condition = "het")
#oligo
targetingCalc(regNetmatrix = oligodendrocytes.control.regNet, variable_name = "oligo", edge_weight_name = ctrl_edge_weight, condition = "ctrl")
targetingCalc(regNetmatrix = oligodendrocytes.heterozygous.regNet, variable_name = "oligo", edge_weight_name = het_edge_weight, condition = "het")
#opcs
targetingCalc(regNetmatrix = opcs.control.regNet, variable_name = "opcs", edge_weight_name = ctrl_edge_weight, condition = "ctrl")
targetingCalc(regNetmatrix = opcs.heterozygous.regNet, variable_name = "opcs", edge_weight_name = het_edge_weight, condition = "het")
```

Confirm targeting is being calculated as suspected by validating with alternate method. Distributions are the same when calculated by aggregate or sums:
```{r comparing-alternate-targeting-score-calc}
pdf(here("results/diff_targeting/cortex_alt_targeting_calc.pdf"))
#HETEROZYGOUS----------------------
#visualize current distribution
hist(astro_TF_targeting_het$het_edge_weight_pos)

#checking alt targeting calc method distribution matches
dim(astrocytes.heterozygous.regNet)
pos <- as.data.frame(pmax(astrocytes.heterozygous.regNet, 0))
TF_t_het <- as.data.frame(rowSums(pos))
TF_t_het$TF <- rownames(pos)
hist(TF_t_het$`rowSums(pos)`)
G_t_het <- as.data.frame(colSums(pos))
G_t_het$gene <- colnames(pos)
hist(G_t_het$`colSums(pos)`)

#CONTROL----------------------
#visualize current distribution
hist(astro_TF_targeting_ctrl$ctrl_edge_weight_pos)

#checking alt targeting calc method distribution matches
dim(astrocytes.control.regNet)
pos <- as.data.frame(pmax(astrocytes.control.regNet, 0))
TF_t_ctrl <- as.data.frame(rowSums(pos))
TF_t_ctrl$TF <- rownames(pos)
hist(TF_t_ctrl$`rowSums(pos)`)
G_t_ctrl <- as.data.frame(colSums(pos))
G_t_ctrl$gene <- colnames(pos)
hist(G_t_ctrl$`colSums(pos)`)
dev.off()
```

## combine ctrl and het to into single data frame 
```{r wrangling-data-to-combine}
# Astro ----------
TF_targeting_astro <- merge(astro_TF_targeting_ctrl, astro_TF_targeting_het, by = "TF") #combine dataframes 
Gene_targeting_astro <- merge(astro_gene_targeting_ctrl, astro_gene_targeting_het, by = "gene") #combine dataframes 

# micro ----------
TF_targeting_micro <- merge(micro_TF_targeting_ctrl, micro_TF_targeting_het, by = "TF") #combine dataframes 
Gene_targeting_micro <- merge(micro_gene_targeting_ctrl, micro_gene_targeting_het, by = "gene") #combine dataframes 

# inhibitory ----------
TF_targeting_inhibitory <- merge(inhibitory_TF_targeting_ctrl, inhibitory_TF_targeting_het, by = "TF") #combine dataframes 
Gene_targeting_inhibitory <- merge(inhibitory_gene_targeting_ctrl, inhibitory_gene_targeting_het, by = "gene") #combine dataframes 

# excitatory ----------
TF_targeting_excitatory <- merge(excitatory_TF_targeting_ctrl, inhibitory_TF_targeting_het, by = "TF") #combine dataframes 
Gene_targeting_excitatory <- merge(excitatory_gene_targeting_ctrl, excitatory_gene_targeting_het, by = "gene") #combine dataframes 

# oligodendrocyte ----------
TF_targeting_oligodendrocyte <- merge(oligo_TF_targeting_ctrl, oligo_TF_targeting_het, by = "TF") #combine dataframes 
Gene_targeting_oligodendrocyte <- merge(oligo_gene_targeting_ctrl, oligo_gene_targeting_het, by = "gene") #combine dataframes 

# opcs ----------
TF_targeting_opcs <- merge(opcs_TF_targeting_ctrl, opcs_TF_targeting_het, by = "TF") #combine dataframes
Gene_targeting_opcs <- merge(opcs_gene_targeting_ctrl, opcs_gene_targeting_het, by = "gene") #combine dataframes 

# mural ----------
TF_targeting_mural <- merge(mural_TF_targeting_ctrl, mural_TF_targeting_het, by = "TF") #combine dataframes 
Gene_targeting_mural <- merge(mural_gene_targeting_ctrl, mural_gene_targeting_het, by = "gene") #combine dataframes 

# fibro ----------
TF_targeting_fibro <- merge(fibro_TF_targeting_ctrl, fibro_TF_targeting_het, by = "TF") #combine dataframes 
Gene_targeting_fibro <- merge(fibro_gene_targeting_ctrl, fibro_gene_targeting_het, by = "gene") #combine dataframes 
```

# Investigate targeting differences across Het cell types:
```{r constructing-het-targeting-matrix}
TF_targeting_all_het <- merge(TF_targeting_astro[,c(1,3)], TF_targeting_excitatory[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_inhibitory[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_micro[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_mural[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_oligodendrocyte[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_opcs[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_fibro[,c(1,3)], by = "TF")

colnames(TF_targeting_all_het) <- c("TF", "astrocytes", "excitatory", "inhibitory", "micro", "mural", "oligodendrocyte", "opcs", "fibro")

gene_targeting_all_het <- merge(Gene_targeting_astro[,c(1,3)], Gene_targeting_excitatory[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_inhibitory[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_micro[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_mural[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_oligodendrocyte[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_opcs[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_fibro[,c(1,3)], by = "gene")

colnames(gene_targeting_all_het) <- c("gene", "astrocytes", "excitatory", "inhibitory", "micro", "mural", "oligodendrocyte", "opcs", "fibro")
```

```{r find-top-targeted-genes-across-het-celltypes}
#identify the maximum for each row
max <- pmax(gene_targeting_all_het$astrocytes, gene_targeting_all_het$excitatory, gene_targeting_all_het$inhibitory, gene_targeting_all_het$micro, gene_targeting_all_het$mural, gene_targeting_all_het$oligodendrocyte, gene_targeting_all_het$opcs, gene_targeting_all_het$fibro)

#subtract each value from the maximum by gene; the gene with the most positive rowsum is the most variably targeted across cell types, and the cell type with a value = 0 represents the cell type with the highest targeting for that gene
gene_targeting_ranked <- max - gene_targeting_all_het[,c(2:9)]
gene_targeting_ranked$rank_sum <- rowSums(gene_targeting_ranked)
#gene_targeting_ranked$max <- max

#adding gene names back
gene_targeting_ranked$gene <- gene_targeting_all_het$gene 

#sorting and annotating
gene_targeting_ranked <- gene_targeting_ranked %>% arrange(desc(rank_sum))
gene_targeting_ranked$rank <- seq(1:nrow(gene_targeting_ranked))

#adding rank to targeting score dataframe
gene_targeting_all_het <- merge(gene_targeting_ranked[,10:11], gene_targeting_all_het, by = "gene")
gene_targeting_all_het <- arrange(gene_targeting_all_het,rank)
```

```{r visualize-het-gene-targeting-distribution}
pivoted <- pivot_longer(gene_targeting_all_het, values_to = "targeting_score", names_to = "cell_type", cols = c(4:11))
pivoted


png(filename = here("results/diff_targeting/cortex_gene_targeting_dist_het.png"),
    width = 1000,
    height = 500)
ggplot(data=pivoted, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Gene Targeting Score Distribution in S858R Mice") + theme_bw() + scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB","#C216B7","#027461","#7997FF","#00C1AA"))
dev.off()
```

```{r visualizing-het-gene-rank-with-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#formatting input data
data <- gene_targeting_all_het
rownames(data) <- data$gene
data <- data[, -c(1:2)]
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_all_het_heatmap_test.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of All Genes Across Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-het-gene-top100-rank-with-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#formatting input data
data <- gene_targeting_all_het %>% slice(1:100)
rownames(data) <- data$gene
data <- data[, -c(1:3)]
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_targeting_het_top100_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of top 100 Genes Across Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-setbp1-targets-gene-targeting-across-het}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#formatting input data
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")

data <- gene_targeting_all_het[gene_targeting_all_het$gene %in% setbp1_genes,]

rownames(data) <- data$gene
data <- data[, -c(1:3)]
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_het_setbp1targets_across_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Gene targeting of Setbp1 and it's targets Across Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```


```{r find-top-targeted-TFs-across-het-celltypes}
#identify the maximum for each row
max <- pmax(TF_targeting_all_het$astrocytes, TF_targeting_all_het$excitatory, TF_targeting_all_het$inhibitory, TF_targeting_all_het$micro, TF_targeting_all_het$mural, TF_targeting_all_het$oligodendrocyte, TF_targeting_all_het$opcs, TF_targeting_all_het$fibro)

#subtract each value from the maximum by TF; the TF with the most positive rowsum is the most variably targeted across cell types, and the cell type with a value = 0 represents the cell type with the highest targeting for that TF
TF_targeting_ranked <- max - TF_targeting_all_het[,2:9]
TF_targeting_ranked$rank_sum <- rowSums(TF_targeting_ranked)
#TF_targeting_ranked$max <- max

#adding TF names back
TF_targeting_ranked$TF <- TF_targeting_all_het$TF 

#sorting and annotating
TF_targeting_ranked <- TF_targeting_ranked %>% arrange(desc(rank_sum))
TF_targeting_ranked$rank <- seq(1:nrow(TF_targeting_ranked))

#adding rank to targeting score dataframe
TF_targeting_all_het <- merge(TF_targeting_ranked[,10:11], TF_targeting_all_het, by = "TF")
TF_targeting_all_het <- arrange(TF_targeting_all_het,rank)
```

```{r visualize-het-TF-targeting-distribution}
pivoted <- pivot_longer(TF_targeting_all_het, values_to = "targeting_score", names_to = "cell_type", cols = c(3:10))

png(filename = here("results/diff_targeting/cortex_TF_targeting_dist_het.png"),
    width = 1000,
    height = 500)
ggplot(data=pivoted, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("TF Targeting Score Distribution in S858R Mice") + theme_bw() + scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB","#C216B7","#027461","#7997FF","#00C1AA"))
dev.off()
```

```{r visualizing-het-TF-rank-with-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#formatting input data
data <- TF_targeting_all_het
rownames(data) <- data$TF
data <- data[, -c(1:2)]
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_targeting_all_het_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of All TFs Across Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-het-top100-TF-rank-with-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#formatting input data
data <- TF_targeting_all_het %>% slice(1:100)
rownames(data) <- data$TF
data <- data[, -c(1:2)]
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_targeting_het_top100_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of TF Across Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-setbp1-targets-TF-targeting-across-het}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#formatting input data
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")

data <- TF_targeting_all_het[TF_targeting_all_het$TF %in% setbp1_genes,]

rownames(data) <- data$TF
data <- data[, -c(1:2)]
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_targeting_het_setbp1targets_across_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "TF targeting of Setbp1 and it's targets Across Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

# Investigate targeting differences across ctrl cell types:
```{r constructing-ctrl-targeting-matrix}
TF_targeting_all_ctrl <- merge(TF_targeting_astro[,c(1,2)], TF_targeting_excitatory[,c(1,2)], by = "TF")
TF_targeting_all_ctrl <- merge(TF_targeting_all_ctrl, TF_targeting_inhibitory[,c(1,2)], by = "TF")
TF_targeting_all_ctrl <- merge(TF_targeting_all_ctrl, TF_targeting_micro[,c(1,2)], by = "TF")
TF_targeting_all_ctrl <- merge(TF_targeting_all_ctrl, TF_targeting_mural[,c(1,2)], by = "TF")
TF_targeting_all_ctrl <- merge(TF_targeting_all_ctrl, TF_targeting_oligodendrocyte[,c(1,2)], by = "TF")
TF_targeting_all_ctrl <- merge(TF_targeting_all_ctrl, TF_targeting_opcs[,c(1,2)], by = "TF")
TF_targeting_all_ctrl <- merge(TF_targeting_all_ctrl, TF_targeting_fibro[,c(1,2)], by = "TF")

colnames(TF_targeting_all_ctrl) <- c("TF", "astrocytes", "excitatory", "inhibitory", "micro", "mural", "oligodendrocyte", "opcs", "fibro")

gene_targeting_all_ctrl <- merge(Gene_targeting_astro[,c(1,2)], Gene_targeting_excitatory[,c(1,2)], by = "gene")
gene_targeting_all_ctrl <- merge(gene_targeting_all_ctrl, Gene_targeting_inhibitory[,c(1,2)], by = "gene")
gene_targeting_all_ctrl <- merge(gene_targeting_all_ctrl, Gene_targeting_micro[,c(1,2)], by = "gene")
gene_targeting_all_ctrl <- merge(gene_targeting_all_ctrl, Gene_targeting_mural[,c(1,2)], by = "gene")
gene_targeting_all_ctrl <- merge(gene_targeting_all_ctrl, Gene_targeting_oligodendrocyte[,c(1,2)], by = "gene")
gene_targeting_all_ctrl <- merge(gene_targeting_all_ctrl, Gene_targeting_opcs[,c(1,2)], by = "gene")
gene_targeting_all_ctrl <- merge(gene_targeting_all_ctrl, Gene_targeting_fibro[,c(1,2)], by = "gene")

colnames(gene_targeting_all_ctrl) <- c("gene", "astrocytes", "excitatory", "inhibitory", "micro", "mural", "oligodendrocyte", "opcs", "fibro")
```

```{r find-top-targeted-genes-across-ctrl-celltypes}
#identify the maximum for each row
max <- pmax(gene_targeting_all_ctrl$astrocytes, gene_targeting_all_ctrl$excitatory, gene_targeting_all_ctrl$inhibitory, gene_targeting_all_ctrl$micro, gene_targeting_all_ctrl$mural, gene_targeting_all_ctrl$oligodendrocyte, gene_targeting_all_ctrl$opcs, gene_targeting_all_ctrl$fibro)

#subtract each value from the maximum by gene; the gene with the most positive rowsum is the most variably targeted across cell types, and the cell type with a value = 0 represents the cell type with the highest targeting for that gene
gene_targeting_ranked <- max - gene_targeting_all_ctrl[,2:9]
gene_targeting_ranked$rank_sum <- rowSums(gene_targeting_ranked)
#gene_targeting_ranked$max <- max

#adding gene names back
gene_targeting_ranked$gene <- gene_targeting_all_ctrl$gene 

#sorting and annotating
gene_targeting_ranked <- gene_targeting_ranked %>% arrange(desc(rank_sum))
gene_targeting_ranked$rank <- seq(1:nrow(gene_targeting_ranked))

#adding rank to targeting score dataframe
gene_targeting_all_ctrl <- merge(gene_targeting_ranked[,10:11], gene_targeting_all_ctrl, by = "gene")
gene_targeting_all_ctrl <- arrange(gene_targeting_all_ctrl,rank)
```

```{r visualize-ctrl-gene-targeting-distribution}
pivoted <- pivot_longer(gene_targeting_all_ctrl, values_to = "targeting_score", names_to = "cell_type", cols = c(3:10))
pivoted

png(filename = here("results/diff_targeting/cortex_gene_targeting_dist_ctrl.png"),
    width = 1000,
    height = 500)
ggplot(data=pivoted, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Gene targeting score distribution in Controls") + theme_bw() + scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB","#C216B7","#027461","#7997FF","#00C1AA"))
dev.off()

summary(gene_targeting_all_ctrl)
```

```{r visualizing-ctrl-gene-rank-with-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#formatting input data
data <- gene_targeting_all_ctrl
rownames(data) <- data$gene
data <- data[, -c(1:2)]
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_all_ctrl_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of All Genes Across Cell-types in Setbp1 Ctrl Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ctrl-gene-top100-rank-with-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#formatting input data
data <- gene_targeting_all_ctrl %>% slice(1:100)
rownames(data) <- data$gene
data <- data[, -c(1:2)]
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_targeting_ctrl_top100_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of top 100 Genes Across Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-setbp1-targets-genes-targeting-across-ctrl}
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")

data <- gene_targeting_all_ctrl[gene_targeting_all_ctrl$gene %in% setbp1_genes,]

rownames(data) <- data$gene
data <- data[, -c(1:2)]
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_ctrl_setbp1targets_across_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Gene targeting of Setbp1 and it's targets Across Cell-types in Setbp1 Control Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```



```{r find-top-targeted-TFs-across-ctrl-celltypes}
#identify the maximum for each row
max <- pmax(TF_targeting_all_ctrl$astrocytes, TF_targeting_all_ctrl$excitatory, TF_targeting_all_ctrl$inhibitory, TF_targeting_all_ctrl$micro, TF_targeting_all_ctrl$mural, TF_targeting_all_ctrl$oligodendrocyte, TF_targeting_all_ctrl$opcs, TF_targeting_all_ctrl$fibro)

#subtract each value from the maximum by TF; the TF with the most positive rowsum is the most variably targeted across cell types, and the cell type with a value = 0 represents the cell type with the highest targeting for that TF
TF_targeting_ranked <- max - TF_targeting_all_ctrl[,2:9]
TF_targeting_ranked$rank_sum <- rowSums(TF_targeting_ranked)
#TF_targeting_ranked$max <- max

#adding TF names back
TF_targeting_ranked$TF <- TF_targeting_all_ctrl$TF 

#sorting and annotating
TF_targeting_ranked <- TF_targeting_ranked %>% arrange(desc(rank_sum))
TF_targeting_ranked$rank <- seq(1:nrow(TF_targeting_ranked))

#adding rank to targeting score dataframe
TF_targeting_all_ctrl <- merge(TF_targeting_ranked[,10:11], TF_targeting_all_ctrl, by = "TF")
TF_targeting_all_ctrl <- arrange(TF_targeting_all_ctrl,rank)
```

```{r visualize-ctrl-TF-targeting-distribution}
pivoted <- pivot_longer(TF_targeting_all_ctrl, values_to = "targeting_score", names_to = "cell_type", cols = c(3:10))
pivoted

png(filename = here("results/diff_targeting/cortex_TF_targeting_dist_ctrl.png"),
    width = 1000,
    height = 500)
ggplot(data=pivoted, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("TF targeting score distribution in Controls") + theme_bw() + scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB","#C216B7","#027461","#7997FF","#00C1AA"))

summary(TF_targeting_all_ctrl)
```

```{r visualizing-ctrl-TF-rank-with-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- TF_targeting_all_ctrl
rownames(data) <- data$TF
data <- data[, -c(1:2)]
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_targeting_all_ctrl_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of All TFs Across Cell-types in Setbp1 Control Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ctrl-top100-TF-rank-with-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#formatting input data
data <- TF_targeting_all_ctrl %>% slice(1:100)
rownames(data) <- data$TF
data <- data[, -c(1:2)]
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_targeting_ctrl_top100_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of top 100 TF Across Cell-types in Setbp1 Control Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-setbp1-targets-TF-targeting-across-ctrl}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#formatting input data
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")

data <- TF_targeting_all_ctrl[TF_targeting_all_ctrl$TF %in% setbp1_genes,]

rownames(data) <- data$TF
data <- data[, -c(1:2)]
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_targeting_ctrl_setbp1targets_across_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "TF targeting of Setbp1 and it's targets Across Cell-types in Setbp1 Control Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```


# Investigate targeting rank within each Het cell type 
```{r constructing-het-targeting-matrix}
TF_targeting_all_het <- merge(TF_targeting_astro[,c(1,3)], TF_targeting_excitatory[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_inhibitory[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_micro[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_mural[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_oligodendrocyte[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_opcs[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_fibro[,c(1,3)], by = "TF")

colnames(TF_targeting_all_het) <- c("TF", "astrocytes", "excitatory", "inhibitory", "micro", "mural", "oligodendrocyte", "opcs", "fibro")

gene_targeting_all_het <- merge(Gene_targeting_astro[,c(1,3)], Gene_targeting_excitatory[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_inhibitory[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_micro[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_mural[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_oligodendrocyte[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_opcs[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_fibro[,c(1,3)], by = "gene")

colnames(gene_targeting_all_het) <- c("gene", "astrocytes", "excitatory", "inhibitory", "micro", "mural", "oligodendrocyte", "opcs", "fibro")
```

```{r find-top-targeted-TFs-within-het-celltypes}
#rank TFs by targeting for each cell type , find top 20
astro_rank_het <- TF_targeting_all_het[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% slice(1:20) %>% rename(targeting_score = astrocytes)
ex_rank_het <- TF_targeting_all_het[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% slice(1:20) %>% rename(targeting_score = excitatory)
in_rank_het <- TF_targeting_all_het[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% slice(1:20) %>% rename(targeting_score = inhibitory)
micro_rank_het <- TF_targeting_all_het[ ,c(1,5)] %>% arrange(desc(micro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "micro") %>% slice(1:20) %>% rename(targeting_score = micro)
mural_rank_het <- TF_targeting_all_het[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% slice(1:20) %>% rename(targeting_score = mural)
oligo_rank_het <- TF_targeting_all_het[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% slice(1:20) %>% rename(targeting_score = oligodendrocyte)
opcs_rank_het <- TF_targeting_all_het[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% slice(1:20)  %>% rename(targeting_score = opcs)
fibro_rank_het <- TF_targeting_all_het[ ,c(1,9)] %>% arrange(desc(fibro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "fibro") %>% slice(1:20)  %>% rename(targeting_score = fibro)

het_TF_targeting_within <- rbind(astro_rank_het, ex_rank_het, in_rank_het, micro_rank_het, mural_rank_het, oligo_rank_het, opcs_rank_het, fibro_rank_het)
```

```{r visualizing-het-TF-rank-with-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- het_TF_targeting_within[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_targeting_top20_het_within_celltype_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of Top 20 TFs within Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ALL-het-TF-rank-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- het_all_TF_targeting_within[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_targeting_het_all_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of all TFs within Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r het-setbp1-TF-targets-within}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#subsetting for gene set
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")

data <- het_all_TF_targeting_within[het_all_TF_targeting_within$TF %in% setbp1_genes,]

##formatting input data
data <- data[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names

#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_targeting_het_Setbp1targets_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of Setbp1 and known target TFs within Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```


```{r find-top-targeted-genes-within-het-celltypes}
#rank genes by targeting for each cell type , find top 20
astro_rank_het <- gene_targeting_all_het[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% slice(1:20) %>% rename(targeting_score = astrocytes)
ex_rank_het <- gene_targeting_all_het[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% slice(1:20) %>% rename(targeting_score = excitatory)
in_rank_het <- gene_targeting_all_het[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% slice(1:20) %>% rename(targeting_score = inhibitory)
micro_rank_het <- gene_targeting_all_het[ ,c(1,5)] %>% arrange(desc(micro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "micro") %>% slice(1:20) %>% rename(targeting_score = micro)
mural_rank_het <- gene_targeting_all_het[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% slice(1:20) %>% rename(targeting_score = mural)
oligo_rank_het <- gene_targeting_all_het[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% slice(1:20) %>% rename(targeting_score = oligodendrocyte)
opcs_rank_het <- gene_targeting_all_het[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% slice(1:20)  %>% rename(targeting_score = opcs)
fibro_rank_het <- gene_targeting_all_het[ ,c(1,9)] %>% arrange(desc(fibro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "fibro") %>% slice(1:20)  %>% rename(targeting_score = fibro)

het_gene_targeting_within <- rbind(astro_rank_het, ex_rank_het, in_rank_het, micro_rank_het, mural_rank_het, oligo_rank_het, opcs_rank_het, fibro_rank_het)

#rank genes by targeting for each cell type, look at all genes
astro_rank_het <- gene_targeting_all_het[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% rename(targeting_score = astrocytes)
ex_rank_het <- gene_targeting_all_het[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% rename(targeting_score = excitatory)
in_rank_het <- gene_targeting_all_het[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% rename(targeting_score = inhibitory)
micro_rank_het <- gene_targeting_all_het[ ,c(1,5)] %>% arrange(desc(micro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "micro") %>% rename(targeting_score = micro)
mural_rank_het <- gene_targeting_all_het[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% rename(targeting_score = mural)
oligo_rank_het <- gene_targeting_all_het[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% rename(targeting_score = oligodendrocyte)
opcs_rank_het <- gene_targeting_all_het[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% rename(targeting_score = opcs)
fibro_rank_het <- gene_targeting_all_het[ ,c(1,9)] %>% arrange(desc(fibro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "fibro") %>% rename(targeting_score = fibro)
het_all_gene_targeting_within <- rbind(astro_rank_het, ex_rank_het, in_rank_het, micro_rank_het, mural_rank_het, oligo_rank_het, opcs_rank_het, fibro_rank_het)
```


```{r visualizing-het-gene-rank-with-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- het_gene_targeting_within[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_top20_het_within_celltype_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of Top 20 genes within Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ALL-het-gene-rank-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- het_all_gene_targeting_within[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_het_all_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of all genes within Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r het-setbp1-gene-targets-within}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#filtering setbp1
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")

data <- het_all_gene_targeting_within[het_all_gene_targeting_within$gene %in% setbp1_genes,]

##formatting input data
data <- data[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names

#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_het_Setbp1targets_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of Setbp1 and known target genes within Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```


# Investigate targeting rank within each Ctrl cell type 
```{r constructing-ctrl-targeting-matrix}
TF_targeting_all_ctrl <- merge(TF_targeting_astro[,c(1,2)], TF_targeting_excitatory[,c(1,2)], by = "TF")
TF_targeting_all_ctrl <- merge(TF_targeting_all_ctrl, TF_targeting_inhibitory[,c(1,2)], by = "TF")
TF_targeting_all_ctrl <- merge(TF_targeting_all_ctrl, TF_targeting_micro[,c(1,2)], by = "TF")
TF_targeting_all_ctrl <- merge(TF_targeting_all_ctrl, TF_targeting_mural[,c(1,2)], by = "TF")
TF_targeting_all_ctrl <- merge(TF_targeting_all_ctrl, TF_targeting_oligodendrocyte[,c(1,2)], by = "TF")
TF_targeting_all_ctrl <- merge(TF_targeting_all_ctrl, TF_targeting_opcs[,c(1,2)], by = "TF")
TF_targeting_all_ctrl <- merge(TF_targeting_all_ctrl, TF_targeting_fibro[,c(1,2)], by = "TF")

colnames(TF_targeting_all_ctrl) <- c("TF", "astrocytes", "excitatory", "inhibitory", "micro", "mural", "oligodendrocyte", "opcs", "fibro")

gene_targeting_all_ctrl <- merge(Gene_targeting_astro[,c(1,2)], Gene_targeting_excitatory[,c(1,2)], by = "gene")
gene_targeting_all_ctrl <- merge(gene_targeting_all_ctrl, Gene_targeting_inhibitory[,c(1,2)], by = "gene")
gene_targeting_all_ctrl <- merge(gene_targeting_all_ctrl, Gene_targeting_micro[,c(1,2)], by = "gene")
gene_targeting_all_ctrl <- merge(gene_targeting_all_ctrl, Gene_targeting_mural[,c(1,2)], by = "gene")
gene_targeting_all_ctrl <- merge(gene_targeting_all_ctrl, Gene_targeting_oligodendrocyte[,c(1,2)], by = "gene")
gene_targeting_all_ctrl <- merge(gene_targeting_all_ctrl, Gene_targeting_opcs[,c(1,2)], by = "gene")
gene_targeting_all_ctrl <- merge(gene_targeting_all_ctrl, Gene_targeting_fibro[,c(1,2)], by = "gene")

colnames(gene_targeting_all_ctrl) <- c("gene", "astrocytes", "excitatory", "inhibitory", "micro", "mural", "oligodendrocyte", "opcs", "fibro")
```


```{r find-top-targeted-genes-within-ctrl-celltypes}
#rank genes by targeting for each cell type , find top 20
astro_rank_ctrl <- gene_targeting_all_ctrl[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% slice(1:20) %>% rename(targeting_score = astrocytes)
ex_rank_ctrl <- gene_targeting_all_ctrl[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% slice(1:20) %>% rename(targeting_score = excitatory)
in_rank_ctrl <- gene_targeting_all_ctrl[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% slice(1:20) %>% rename(targeting_score = inhibitory)
micro_rank_ctrl <- gene_targeting_all_ctrl[ ,c(1,5)] %>% arrange(desc(micro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "micro") %>% slice(1:20) %>% rename(targeting_score = micro)
mural_rank_ctrl <- gene_targeting_all_ctrl[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% slice(1:20) %>% rename(targeting_score = mural)
oligo_rank_ctrl <- gene_targeting_all_ctrl[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% slice(1:20) %>% rename(targeting_score = oligodendrocyte)
opcs_rank_ctrl <- gene_targeting_all_ctrl[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% slice(1:20)  %>% rename(targeting_score = opcs)
fibro_rank_ctrl <- gene_targeting_all_ctrl[ ,c(1,9)] %>% arrange(desc(fibro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "fibro") %>% slice(1:20)  %>% rename(targeting_score = fibro)

ctrl_gene_targeting_within <- rbind(astro_rank_ctrl, ex_rank_ctrl, in_rank_ctrl, micro_rank_ctrl, mural_rank_ctrl, oligo_rank_ctrl, opcs_rank_ctrl, fibro_rank_ctrl)

#rank genes by targeting for each cell type, look at all genes
astro_rank_ctrl<- gene_targeting_all_ctrl[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% rename(targeting_score = astrocytes)
ex_rank_ctrl<- gene_targeting_all_ctrl[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% rename(targeting_score = excitatory)
in_rank_ctrl<- gene_targeting_all_ctrl[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% rename(targeting_score = inhibitory)
micro_rank_ctrl<- gene_targeting_all_ctrl[ ,c(1,5)] %>% arrange(desc(micro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "micro") %>% rename(targeting_score = micro)
mural_rank_ctrl<- gene_targeting_all_ctrl[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% rename(targeting_score = mural)
oligo_rank_ctrl<- gene_targeting_all_ctrl[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% rename(targeting_score = oligodendrocyte)
opcs_rank_ctrl<- gene_targeting_all_ctrl[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% rename(targeting_score = opcs)
fibro_rank_ctrl<- gene_targeting_all_ctrl[ ,c(1,9)] %>% arrange(desc(fibro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "fibro") %>% rename(targeting_score = fibro)

ctrl_all_gene_targeting_within <- rbind(astro_rank_ctrl, ex_rank_ctrl, in_rank_ctrl, micro_rank_ctrl, mural_rank_ctrl, oligo_rank_ctrl, opcs_rank_ctrl, fibro_rank_ctrl)
```

```{r find-top-targeted-TFs-within-ctrl-celltypes}
#rank TFs by targeting for each cell type , find top 20
astro_rank_ctrl <- TF_targeting_all_ctrl[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% slice(1:20) %>% rename(targeting_score = astrocytes)
ex_rank_ctrl <- TF_targeting_all_ctrl[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% slice(1:20) %>% rename(targeting_score = excitatory)
in_rank_ctrl <- TF_targeting_all_ctrl[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% slice(1:20) %>% rename(targeting_score = inhibitory)
micro_rank_ctrl <- TF_targeting_all_ctrl[ ,c(1,5)] %>% arrange(desc(micro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "micro") %>% slice(1:20) %>% rename(targeting_score = micro)
mural_rank_ctrl <- TF_targeting_all_ctrl[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% slice(1:20) %>% rename(targeting_score = mural)
oligo_rank_ctrl <- TF_targeting_all_ctrl[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% slice(1:20) %>% rename(targeting_score = oligodendrocyte)
opcs_rank_ctrl <- TF_targeting_all_ctrl[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% slice(1:20)  %>% rename(targeting_score = opcs)
fibro_rank_ctrl <- TF_targeting_all_ctrl[ ,c(1,9)] %>% arrange(desc(fibro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "fibro") %>% slice(1:20)  %>% rename(targeting_score = fibro)

ctrl_TF_targeting_within <- rbind(astro_rank_ctrl, ex_rank_ctrl, in_rank_ctrl, micro_rank_ctrl, mural_rank_ctrl, oligo_rank_ctrl, opcs_rank_ctrl, fibro_rank_ctrl)

#rank TFs by targeting for each cell type, look at all genes
astro_rank_ctrl<- TF_targeting_all_ctrl[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% rename(targeting_score = astrocytes)
ex_rank_ctrl<- TF_targeting_all_ctrl[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% rename(targeting_score = excitatory)
in_rank_ctrl<- TF_targeting_all_ctrl[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% rename(targeting_score = inhibitory)
micro_rank_ctrl<- TF_targeting_all_ctrl[ ,c(1,5)] %>% arrange(desc(micro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "micro") %>% rename(targeting_score = micro)
mural_rank_ctrl<- TF_targeting_all_ctrl[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% rename(targeting_score = mural)
oligo_rank_ctrl<- TF_targeting_all_ctrl[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% rename(targeting_score = oligodendrocyte)
opcs_rank_ctrl<- TF_targeting_all_ctrl[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% rename(targeting_score = opcs)
fibro_rank_ctrl<- TF_targeting_all_ctrl[ ,c(1,9)] %>% arrange(desc(fibro)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "fibro") %>% rename(targeting_score = fibro)

ctrl_all_TF_targeting_within <- rbind(astro_rank_ctrl, ex_rank_ctrl, in_rank_ctrl, micro_rank_ctrl, mural_rank_ctrl, oligo_rank_ctrl, opcs_rank_ctrl, fibro_rank_ctrl)
```
```{r visualizing-ctrl-gene-rank-with-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- ctrl_gene_targeting_within[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_top20_ctrl_within_celltype_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of Top 20 genes within Cell-types in Setbp1 Ctrl Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ALL-ctrl-gene-rank-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- ctrl_all_gene_targeting_within[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_ctrl_all_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of all genes within Cell-types in Setbp1 Ctrl Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```


```{r ctrl-setbp1-gene-targets-within}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#filtering based off of gene set 
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")

data <- ctrl_all_gene_targeting_within[ctrl_all_gene_targeting_within$gene %in% setbp1_genes,]

##formatting input data
data <- data[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_ctrl_Setbp1targets_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of Setbp1 and known target genes within Cell-types in Setbp1 Control Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ctrl-TF-rank-with-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- ctrl_TF_targeting_within[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add TF names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_targeting_top20_ctrl_within_celltype_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of Top 20 TFs within Cell-types in Setbp1 Ctrl Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ALL-ctrl-TF-rank-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- ctrl_all_TF_targeting_within[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add TF names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_targeting_ctrl_all_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of all TFs within Cell-types in Setbp1 Ctrl Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r ctrl-setbp1-TF-targets-within}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#subsetting for gene set
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")

data <- ctrl_all_TF_targeting_within[ctrl_all_TF_targeting_within$TF %in% setbp1_genes,]

##formatting input data
data <- data[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add TF names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names

#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_targeting_ctrl_Setbp1targets_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of Setbp1 and known target TFs within Cell-types in Setbp1 Control Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

####################################

# calculating differential targeting score between conditions 
GOAL: ID genes/TFs with largest difference in targeting between conditions within each cell type:
Using the combined het/ctrl dataframe for each cell type above, calculate the difference (het-ctrl) for the targeting weight where the more positive difference indicates higher gene targeting in het and more negative diff indicates higher gene targeting in ctrl. The closer a value is to 0, the less difference in targeting between conditions for that cell type

```{r rearrange-data-calc-diff}
#wrangle data
combined_gene_targeting <- cbind(gene_targeting_all_het, gene_targeting_all_ctrl)
combined_gene_targeting <- combined_gene_targeting[,-10] #remove duplicate "gene" column
colnames(combined_gene_targeting) <- c("gene", "astrocytes_het", "excitatory_het", "inhibitory_het", "micro_het", "mural_het", "oligodendrocyte_het", "opcs_het", "fibro_het", "astrocytes_ctrl", "excitatory_ctrl", "inhibitory_ctrl", "micro_ctrl", "mural_ctrl", "oligodendrocyte_ctrl", "opcs_ctrl", "fibro_ctrl")

diff_gene_targeting <- data.frame(matrix(NA, nrow = 22033, ncol = 9))
diff_gene_targeting$X1 <- combined_gene_targeting$gene
colnames(diff_gene_targeting) <- c("gene", "astrocytes", "excitatory", "inhibitory", "microglia", "mural", "oligodendrocyte", "opcs", "fibro")

#calculate diff targeting for each cell type 
diff_gene_targeting$astrocytes <- combined_gene_targeting$astrocytes_het - combined_gene_targeting$astrocytes_ctrl
diff_gene_targeting$excitatory <- combined_gene_targeting$excitatory_het - combined_gene_targeting$excitatory_ctrl
diff_gene_targeting$inhibitory <- combined_gene_targeting$inhibitory_het - combined_gene_targeting$inhibitory_ctrl
diff_gene_targeting$microglia <- combined_gene_targeting$micro_het - combined_gene_targeting$micro_ctrl
diff_gene_targeting$mural <- combined_gene_targeting$mural_het - combined_gene_targeting$mural_ctrl
diff_gene_targeting$oligodendrocyte <- combined_gene_targeting$oligodendrocyte_het - combined_gene_targeting$oligodendrocyte_ctrl
diff_gene_targeting$opcs <- combined_gene_targeting$opcs_het - combined_gene_targeting$opcs_ctrl
diff_gene_targeting$fibro <- combined_gene_targeting$fibro_het - combined_gene_targeting$fibro_ctrl

het_enriched <- replace(diff_gene_targeting, diff_gene_targeting[,] < 0, 0) #creating dataframe where the differential is enriched in the het condition
save(het_enriched, file = here("results/diff_targeting/het_enriched.Rdata"))
ctrl_enriched <- replace(diff_gene_targeting, diff_gene_targeting[,] > 0, 0) #creating dataframe where the differential is enriched in the ctrl condition
save(ctrl_enriched, file = here("results/diff_targeting/ctrl_enriched.Rdata"))
```

```{r visualizing-all-diff-gene-het-enriched}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- het_enriched
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_DIFFtargeting_het_enriched_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Differential Targeting of S858R enriched genes in Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-all-diff-gene-het-enriched-setbp1genes}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
#filtering for gene set
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1") #683 aliases total

data <- het_enriched[het_enriched$gene %in% setbp1_genes,]

names <- data$gene #add names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_DIFFtargeting_het_Setbp1targets_enriched_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Differential Gene Targeting of known targets of Setbp1 in S858R enriched genes of Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r GO-difftargeting-genes-Setbp1Target-het-enriched}
##pathway analysis and plotting
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1") #683 aliases total

data <- het_enriched[het_enriched$gene %in% setbp1_genes,] %>% pivot_longer(., cols = 2:9, names_to = "cell_type", values_to =  "targeting_score") %>% .[!.$targeting_score == 0,]


#astrocytes ----------
top <- data[data$cell_type == "astrocytes",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_astro_genes_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted genes (Setbp1 or known targets) in Setbp1 S858R Astrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#excitatory ------------
top <- data[data$cell_type == "excitatory",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_ex_genes_Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted genes (Setbp1 or known targets) in Setbp1 S858R Excitatory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#inhibitory ------------
top <- data[data$cell_type == "inhibitory",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_inhib_genes_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted genes (Setbp1 or known targets) in Setbp1 S858R inhibitory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#mural ------------
top <- data[data$cell_type == "mural",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_mural_genes_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted genes (Setbp1 or known targets) in Setbp1 S858R Mural cells")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 

#microglia ------------
top <- data[data$cell_type == "microglia",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_microglia_genes_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted genes (Setbp1 or known targets) in Setbp1 S858R microglia")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off()   
    
#oligodendrocytes ------------
top <- data[data$cell_type == "oligodendrocyte",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_oligodendrocytes_genes_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted genes (Setbp1 or known targets) in Setbp1 S858R oligodendrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#opcs ------------
top <- data[data$cell_type == "opcs",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_opcs_genes_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted genes (Setbp1 or known targets) in Setbp1 S858R opcs")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#fibro ------------
top <- data[data$cell_type == "fibro",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_fibro_genes_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted genes (Setbp1 or known targets) in Setbp1 S858R fibro")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
``` 


```{r visualizing-all-diff-gene-ctrl-enriched}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- ctrl_enriched
names <- data$gene #add gene names as rownames
data <- abs(data[,-1])
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_DIFFtargeting_ctrl_enriched_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Differential Targeting of Control enriched genes in Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r rearrange-data-calc-diff-TF}
#wrangle data
combined_TF_targeting <- cbind(TF_targeting_all_het, TF_targeting_all_ctrl)
combined_TF_targeting <- combined_TF_targeting[,-10] #removing duplicate TF column
colnames(combined_TF_targeting) <- c("TF", "astrocytes_het", "excitatory_het", "inhibitory_het", "micro_het", "mural_het", "oligodendrocyte_het", "opcs_het", "fibro_het", "astrocytes_ctrl", "excitatory_ctrl", "inhibitory_ctrl", "micro_ctrl", "mural_ctrl", "oligodendrocyte_ctrl", "opcs_ctrl", "fibro_ctrl")

diff_TF_targeting <- data.frame(matrix(NA, nrow = 1080, ncol = 9))
diff_TF_targeting$X1 <- combined_TF_targeting$TF
colnames(diff_TF_targeting) <- c("TF", "astrocytes", "excitatory", "inhibitory", "microglia", "mural", "oligodendrocyte", "opcs", "fibro")

#calculate diff targeting for each cell type 
diff_TF_targeting$astrocytes <- combined_TF_targeting$astrocytes_het - combined_TF_targeting$astrocytes_ctrl
diff_TF_targeting$excitatory <- combined_TF_targeting$excitatory_het - combined_TF_targeting$excitatory_ctrl
diff_TF_targeting$inhibitory <- combined_TF_targeting$inhibitory_het - combined_TF_targeting$inhibitory_ctrl
diff_TF_targeting$microglia <- combined_TF_targeting$micro_het - combined_TF_targeting$micro_ctrl
diff_TF_targeting$mural <- combined_TF_targeting$mural_het - combined_TF_targeting$mural_ctrl
diff_TF_targeting$oligodendrocyte <- combined_TF_targeting$oligodendrocyte_het - combined_TF_targeting$oligodendrocyte_ctrl
diff_TF_targeting$opcs <- combined_TF_targeting$opcs_het - combined_TF_targeting$opcs_ctrl

het_enriched_TF <- replace(diff_TF_targeting, diff_TF_targeting[,] < 0, 0) #creating dataframe where the differential is enriched in the het condition
ctrl_enriched_TF <- replace(diff_TF_targeting, diff_TF_targeting[,] > 0, 0) #creating dataframe where the differential is enriched in the ctrl condition
```

## investigating whether targeting weight distributions are significantly different
```{r wilcoxon-test-TF}
pivoted <- pivot_longer(het_enriched_TF, values_to = "targeting_score", names_to = "cell_type", cols = c(2:8))
two.way <- aov(targeting_score ~ cell_type + TF, data = pivoted)
summary(two.way)

tukey.two.way <- TukeyHSD(two.way)
plot(tukey.two.way, las = 1)
```



```{r visualizing-all-diff-TF-het-enriched}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- het_enriched_TF
names <- data$TF #add TF names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_DIFFtargeting_het_enriched_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Differential Targeting of S858R enriched TFs in Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-all-diff-TF-het-enriched-setbp1TFs}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1") #683 aliases total

data <- het_enriched_TF[het_enriched_TF$TF %in% setbp1_genes,]

names <- data$TF #add names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- herehere("results/diff_targeting/cortex_TF_DIFFtargeting_het_Setbp1targets_enriched_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Differential TF Targeting of known targets of Setbp1 in S858R enriched TFs of Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r GO-difftargeting-TFs-Setbp1Target-het-enriched}
##pathway analysis and plotting
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1") #683 aliases total

data <- het_enriched_TF[het_enriched_TF$TF %in% setbp1_genes,] %>% pivot_longer(., cols = 2:8, names_to = "cell_type", values_to =  "targeting_score") %>% .[!.$targeting_score == 0,]


#astrocytes ----------
top <- data[data$cell_type == "astrocytes",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_astro_TFs_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted TFs (Setbp1 or known targets) in Setbp1 S858R Astrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#excitatory ------------
top <- data[data$cell_type == "excitatory",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_ex_TFs_Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted TFs (Setbp1 or known targets) in Setbp1 S858R Excitatory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#inhibitory ------------
top <- data[data$cell_type == "inhibitory",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_inhib_TFs_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted TFs (Setbp1 or known targets) in Setbp1 S858R inhibitory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#mural ------------
top <- data[data$cell_type == "mural",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_mural_TFs_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted TFs (Setbp1 or known targets) in Setbp1 S858R Mural cells")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 

#microglia ------------
top <- data[data$cell_type == "microglia",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_microglia_TFs_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted TFs (Setbp1 or known targets) in Setbp1 S858R microglia")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off()   
    
#oligodendrocytes ------------
top <- data[data$cell_type == "oligodendrocyte",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_oligodendrocytes_TFs_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted TFs (Setbp1 or known targets) in Setbp1 S858R oligodendrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#opcs ------------
top <- data[data$cell_type == "opcs",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_opcs_TFs_ Setbp1targets_het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted TFs (Setbp1 or known targets) in Setbp1 S858R opcs")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
``` 

```{r visualizing-all-diff-TF-ctrl-enriched}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- ctrl_enriched_TF
names <- data$TF #add TF names as rownames
data <- abs(data[,-1])
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_DIFFtargeting_ctrl_enriched_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Differential Targeting of Control enriched TFs in Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualize-distribution-of-difftargeting-scores}
#het gene distribution
pivoted <- pivot_longer(het_enriched, values_to = "targeting_score", names_to = "cell_type", cols = c(2:8))
ggplot(data=pivoted, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Gene targeting score distribution in S8585R")
summary(het_enriched)

#het gene distribution nonzero
nonzero <- pivoted[pivoted$targeting_score!=0,]
png(filename = here("results/diff_targeting/cortex_difftargeting_het_gene_distribution.png"), 
    width = 1000,
    height = 500)
ggplot(data=nonzero, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Gene differential targeting score distribution in S8585R") + theme_bw() + scale_color_manual(values = c("#6968B4", "#DC71FA", "#00BBDB","#C216B7","#027461","#7997FF","#00C1AA"))
dev.off()
nonzero_long <- pivot_wider(nonzero, names_from =cell_type, values_from = targeting_score)
summary(nonzero_long)

pivoted <- pivot_longer(het_enriched_TF, values_to = "targeting_score", names_to = "cell_type", cols = c(2:8))

summary(het_enriched)



#control gene distribution
pivoted <- pivot_longer(ctrl_enriched, values_to = "targeting_score", names_to = "cell_type", cols = c(2:8))
ggplot(data=pivoted, aes(x=abs(targeting_score), group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Gene targeting score distribution in Control")
summary(ctrl_enriched)

nonzero <- pivoted[pivoted$targeting_score!=0,]


png(filename = here("results/diff_targeting/cortex_difftargeting_ctrl_gene_distribution.png"), 
    width = 1000,
    height = 500)
ggplot(data=nonzero, aes(x=abs(targeting_score), group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Gene differential targeting score distribution in Control") + theme_bw() + scale_color_manual(values = c("#6968B4", "#DC71FA", "#00BBDB","#C216B7","#027461","#7997FF","#00C1AA"))
dev.off()

nonzero_long <- pivot_wider(nonzero, names_from =cell_type, values_from = targeting_score)
nonzero_long <- abs(nonzero_long[,c(2:8)])
summary(nonzero_long)

#het TF distribution
pivoted <- pivot_longer(het_enriched_TF, values_to = "targeting_score", names_to = "cell_type", cols = c(2:8))
ggplot(data=pivoted, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("TF targeting score distribution in S8585R")
summary(het_enriched)

nonzero <- pivoted[pivoted$targeting_score!=0,]
png(filename = here("results/diff_targeting/cortex_difftargeting_het_TF_distribution.png"), 
    width = 1000,
    height = 500)
ggplot(data=nonzero, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("TF differential targeting score distribution in S8585R") + theme_bw() + scale_color_manual(values = c("#6968B4", "#DC71FA", "#00BBDB","#C216B7","#027461","#7997FF","#00C1AA"))
dev.off()


nonzero_long <- pivot_wider(nonzero, names_from =cell_type, values_from = targeting_score)
summary(nonzero_long)

#control TF distribution
pivoted <- pivot_longer(ctrl_enriched_TF, values_to = "targeting_score", names_to = "cell_type", cols = c(2:8))
ggplot(data=pivoted, aes(x=abs(targeting_score), group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("TF targeting score distribution in Control")
summary(ctrl_enriched)

nonzero <- pivoted[pivoted$targeting_score!=0,]
png(filename = here("results/diff_targeting/cortex_difftargeting_ctrl_TF_distribution.png"), 
    width = 1000,
    height = 500)
ggplot(data=nonzero, aes(x=abs(targeting_score), group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("TF differential targeting score distribution in Control") + theme_bw() + scale_color_manual(values = c("#6968B4", "#DC71FA", "#00BBDB","#C216B7","#027461","#7997FF","#00C1AA"))
dev.off()

nonzero_long <- pivot_wider(nonzero, names_from =cell_type, values_from = targeting_score)
nonzero_long <- abs(nonzero_long[,c(2:8)])
summary(nonzero_long)
```

```{r visualize-het-enriched-gene-top20}
#rank TFs by targeting for each cell type , find top 20
astro_rank_het <- het_enriched[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% slice(1:20) %>% rename(targeting_score = astrocytes)
ex_rank_het <- het_enriched[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% slice(1:20) %>% rename(targeting_score = excitatory)
in_rank_het <- het_enriched[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% slice(1:20) %>% rename(targeting_score = inhibitory)
micro_rank_het <- het_enriched[ ,c(1,5)] %>% arrange(desc(microglia)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "microglia") %>% slice(1:20) %>% rename(targeting_score = microglia)
mural_rank_het <- het_enriched[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% slice(1:20) %>% rename(targeting_score = mural)
oligo_rank_het <- het_enriched[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% slice(1:20) %>% rename(targeting_score = oligodendrocyte)
opcs_rank_het <- het_enriched[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% slice(1:20)  %>% rename(targeting_score = opcs)

het_enriched_top <- rbind(astro_rank_het, ex_rank_het, in_rank_het, micro_rank_het, mural_rank_het, oligo_rank_het, opcs_rank_het)
```

```{r visualize-het-enriched-gene-top20-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- het_enriched_top[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_DIFFtargeting_top20_het_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Differential Targeting of Top 20 Genes within Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```


```{r visualize-het-enriched-TF-top20}
#rank TFs by targeting for each cell type , find top 20
astro_rank_het <- het_enriched_TF[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% slice(1:20) %>% rename(targeting_score = astrocytes)
ex_rank_het <- het_enriched_TF[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% slice(1:20) %>% rename(targeting_score = excitatory)
in_rank_het <- het_enriched_TF[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% slice(1:20) %>% rename(targeting_score = inhibitory)
micro_rank_het <- het_enriched_TF[ ,c(1,5)] %>% arrange(desc(microglia)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "microglia") %>% slice(1:20) %>% rename(targeting_score = microglia)
mural_rank_het <- het_enriched_TF[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% slice(1:20) %>% rename(targeting_score = mural)
oligo_rank_het <- het_enriched_TF[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% slice(1:20) %>% rename(targeting_score = oligodendrocyte)
opcs_rank_het <- het_enriched_TF[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% slice(1:20)  %>% rename(targeting_score = opcs)

het_enriched_TF_top <- rbind(astro_rank_het, ex_rank_het, in_rank_het, micro_rank_het, mural_rank_het, oligo_rank_het, opcs_rank_het)
```

```{r visualize-het-enriched-TF-top20-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- het_enriched_TF_top[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add TF names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_DIFFtargeting_top20_het_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Differential Targeting of Top 20 TFs within Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r GO-difftargeting-top20genes-het-enriched}
##pathway analysis and plotting
#astrocytes ----------
top <- het_enriched_top[het_enriched_top$cell_type == "astrocytes",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_astro_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R Astrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#excitatory ------------
top <- het_enriched_top[het_enriched_top$cell_type == "excitatory",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_ex_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R Excitatory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#inhibitory ------------
top <- het_enriched_top[het_enriched_top$cell_type == "inhibitory",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_inhib_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R inhibitory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#mural ------------
top <- het_enriched_top[het_enriched_top$cell_type == "mural",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_mural_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R Mural cells")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 

#microglia ------------
top <- het_enriched_top[het_enriched_top$cell_type == "microglia",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_microglia_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R microglia")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off()   
    
#oligodendrocytes ------------
top <- het_enriched_top[het_enriched_top$cell_type == "oligodendrocyte",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_oligodendrocytes_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R oligodendrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#opcs ------------
top <- het_enriched_top[het_enriched_top$cell_type == "opcs",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_opcs_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R opcs")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
```

```{r GO-difftargeting-top20TFs-het-enriched}
##pathway analysis and plotting
#astrocytes ----------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "astrocytes",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_astro_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R Astrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#excitatory ------------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "excitatory",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_ex_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R Excitatory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#inhibitory ------------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "inhibitory",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_inhib_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R inhibitory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#mural ------------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "mural",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_mural_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R Mural cells")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 

#microglia ------------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "microglia",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_microglia_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R microglia")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off()   
    
#oligodendrocytes ------------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "oligodendrocyte",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_oligodendrocytes_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R oligodendrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#opcs ------------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "opcs",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_opcs_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R opcs")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
``` 


```{r visualize-ctrl-enriched-TF-top20}
#rank TFs by targeting for each cell type , find top 20
ctrl_enriched_TF <- ctrl_enriched_TF[,2:8] %>% abs() %>% mutate(TF= ctrl_enriched_TF$TF)
ctrl_enriched_TF <- ctrl_enriched_TF[,c(8,1,2,3,4,5,6,7)]

astro_rank_ctrl <- ctrl_enriched_TF[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% slice(1:20) %>% rename(targeting_score = astrocytes)
ex_rank_ctrl <- ctrl_enriched_TF[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% slice(1:20) %>% rename(targeting_score = excitatory)
in_rank_ctrl <- ctrl_enriched_TF[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% slice(1:20) %>% rename(targeting_score = inhibitory)
micro_rank_ctrl <- ctrl_enriched_TF[ ,c(1,5)] %>% arrange(desc(microglia)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "microglia") %>% slice(1:20) %>% rename(targeting_score = microglia)
mural_rank_ctrl <- ctrl_enriched_TF[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% slice(1:20) %>% rename(targeting_score = mural)
oligo_rank_ctrl <- ctrl_enriched_TF[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% slice(1:20) %>% rename(targeting_score = oligodendrocyte)
opcs_rank_ctrl <- ctrl_enriched_TF[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% slice(1:20)  %>% rename(targeting_score = opcs)

ctrl_enriched_TF_top <- rbind(astro_rank_ctrl, ex_rank_ctrl, in_rank_ctrl, micro_rank_ctrl, mural_rank_ctrl, oligo_rank_ctrl, opcs_rank_ctrl)
```

```{r visualize-ctrl-enriched-TF-top20-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- ctrl_enriched_TF_top[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add TF names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_TF_DIFFtargeting_top20_ctrl_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Differential Targeting of Top 20 TFs within Cell-types in Setbp1 Control Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualize-ctrl-enriched-gene-top20}

ctrl_enriched <- ctrl_enriched[,2:8] %>% abs() %>% mutate(gene= ctrl_enriched$gene)
ctrl_enriched <- ctrl_enriched[,c(8,1,2,3,4,5,6,7)]

#rank TFs by targeting for each cell type , find top 20
astro_rank_ctrl <- ctrl_enriched[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% slice(1:20) %>% rename(targeting_score = astrocytes)
ex_rank_ctrl <- ctrl_enriched[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% slice(1:20) %>% rename(targeting_score = excitatory)
in_rank_ctrl <- ctrl_enriched[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% slice(1:20) %>% rename(targeting_score = inhibitory)
micro_rank_ctrl <- ctrl_enriched[ ,c(1,5)] %>% arrange(desc(microglia)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "microglia") %>% slice(1:20) %>% rename(targeting_score = microglia)
mural_rank_ctrl <- ctrl_enriched[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% slice(1:20) %>% rename(targeting_score = mural)
oligo_rank_ctrl <- ctrl_enriched[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% slice(1:20) %>% rename(targeting_score = oligodendrocyte)
opcs_rank_ctrl <- ctrl_enriched[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% slice(1:20)  %>% rename(targeting_score = opcs)

ctrl_enriched_top <- rbind(astro_rank_ctrl, ex_rank_ctrl, in_rank_ctrl, micro_rank_ctrl, mural_rank_ctrl, oligo_rank_ctrl, opcs_rank_ctrl)
```


```{r visualize-ctrl-enriched-gene-top20-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- ctrl_enriched_top[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_DIFFtargeting_top20_ctrl_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Differential Targeting of Top 20 Genes within Cell-types in Setbp1 Ctrl Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r GO-difftargeting-top20genes-ctrl-enriched}
##pathway analysis and plotting
#astrocytes ----------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "astrocytes",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_astro_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control Astrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#excitatory ------------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "excitatory",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_ex_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control Excitatory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#inhibitory ------------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "inhibitory",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_inhib_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control inhibitory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#mural ------------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "mural",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_mural_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control Mural cells")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 

#microglia ------------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "microglia",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_microglia_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control microglia")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off()   
    
#oligodendrocytes ------------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "oligodendrocyte",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_oligodendrocytes_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control oligodendrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#opcs ------------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "opcs",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_opcs_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control opcs")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
```

```{r GO-difftargeting-top20TFs-ctrl-enriched}
##pathway analysis and plotting
#astrocytes ----------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "astrocytes",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_astro_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control Astrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#excitatory ------------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "excitatory",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_ex_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control Excitatory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#inhibitory ------------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "inhibitory",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_inhib_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control inhibitory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#mural ------------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "mural",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_mural_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control Mural cells")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 

#microglia ------------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "microglia",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_microglia_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control microglia")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off()   
    
#oligodendrocytes ------------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "oligodendrocyte",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_oligodendrocytes_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control oligodendrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#opcs ------------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "opcs",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_opcs_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control opcs")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
``` 

```{r}
sessionInfo()
```

R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.5 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lintr_3.0.2           styler_1.9.0          here_1.0.1            gprofiler2_0.2.1      readr_2.1.4           circlize_0.4.15       magrittr_2.0.3       
 [8] RColorBrewer_1.1-3    ComplexHeatmap_2.10.0 ggpubr_0.6.0          ggplot2_3.4.1         tidyr_1.3.0           limma_3.50.3          dplyr_1.1.0          
[15] data.table_1.14.8     netZooR_1.2.1         matrixcalc_1.0-6      yarn_1.20.0           pandaR_1.26.0         Biobase_2.54.0        BiocGenerics_0.40.0  
[22] reticulate_1.28       igraph_1.4.1         

loaded via a namespace (and not attached):
  [1] rappdirs_0.3.3              rtracklayer_1.54.0          pbdZMQ_0.3-9                AnnotationForge_1.36.0      R.methodsS3_1.8.2          
  [6] bumphunter_1.36.0           minfi_1.40.0                bit64_4.0.5                 knitr_1.42                  R.utils_2.12.2             
 [11] DelayedArray_0.20.0         KEGGREST_1.34.0             RCurl_1.98-1.10             GEOquery_2.62.2             doParallel_1.0.17          
 [16] generics_0.1.3              GenomicFeatures_1.46.5      preprocessCore_1.56.0       callr_3.7.3                 RSQLite_2.3.0              
 [21] chron_2.3-59                bit_4.0.5                   tzdb_0.3.0                  base64url_1.4               xml2_1.3.3                 
 [26] SummarizedExperiment_1.24.0 assertthat_0.2.1            STRINGdb_2.6.5              xfun_0.37                   hms_1.1.2                  
 [31] evaluate_0.20               fansi_1.0.4                 restfulr_0.0.15             scrime_1.3.5                progress_1.2.2             
 [36] caTools_1.18.2              dbplyr_2.3.1                Rgraphviz_2.38.0            DBI_1.1.3                   htmlwidgets_1.6.1          
 [41] reshape_0.8.9               stats4_4.1.3                purrr_1.0.1                 hash_2.2.6.2                ellipsis_0.3.2             
 [46] backports_1.4.1             permute_0.9-7               annotate_1.72.0             biomaRt_2.50.3              sparseMatrixStats_1.6.0    
 [51] MatrixGenerics_1.6.0        vctrs_0.5.2                 remotes_2.4.2               penalized_0.9-52            abind_1.4-5                
 [56] cachem_1.0.7                withr_2.5.0                 vegan_2.6-4                 GenomicAlignments_1.30.0    prettyunits_1.1.1          
 [61] mclust_6.0.0                cyclocomp_1.1.0             cluster_2.1.2               IRdisplay_1.1               lazyeval_0.2.2             
 [66] crayon_1.5.2                uchardet_1.1.1              genefilter_1.76.0           edgeR_3.36.0                pkgconfig_2.0.3            
 [71] GenomeInfoDb_1.30.1         nlme_3.1-155                nnet_7.3-17                 rlang_1.0.6                 RJSONIO_1.3-1.8            
 [76] lifecycle_1.0.3             downloader_0.4              filelock_1.0.2              BiocFileCache_2.2.1         rex_1.2.1                  
 [81] GOstats_2.60.0              quantro_1.28.0              rprojroot_2.0.3             matrixStats_0.63.0          graph_1.72.0               
 [86] rngtools_1.5.2              base64_2.0.1                Matrix_1.5-3                IRkernel_1.3.2              carData_3.0-5              
 [91] Rhdf5lib_1.16.0             base64enc_0.1-3             processx_3.8.0              GlobalOptions_0.1.2         png_0.1-8                  
 [96] viridisLite_0.4.1           rjson_0.2.21                bitops_1.0-7                R.oo_1.25.0                 KernSmooth_2.23-20         
[101] rhdf5filters_1.6.0          Biostrings_2.62.0           blob_1.2.3                  DelayedMatrixStats_1.16.0   doRNG_1.8.6                
[106] shape_1.4.6                 stringr_1.5.0               nor1mix_1.3-0               R.cache_0.16.0              rstatix_0.7.2              
[111] S4Vectors_0.32.4            ggsignif_0.6.4              scales_1.2.1                memoise_2.0.1               GSEABase_1.56.0            
[116] plyr_1.8.8                  hexbin_1.28.2               gplots_3.1.3                zlibbioc_1.40.0             compiler_4.1.3             
[121] BiocIO_1.4.0                illuminaio_0.36.0           plotrix_3.8-2               clue_0.3-64                 Rsamtools_2.10.0           
[126] cli_3.6.0                   XVector_0.34.0              Category_2.60.0             ps_1.7.2                    MASS_7.3-55                
[131] mgcv_1.8-39                 tidyselect_1.2.0            stringi_1.7.12              yaml_2.3.7                  askpass_1.1                
[136] locfit_1.5-9.7              tools_4.1.3                 parallel_4.1.3              rstudioapi_0.14             uuid_1.1-0                 
[141] foreach_1.5.2               digest_0.6.31               proto_1.0.0                 quadprog_1.5-8              Rcpp_1.0.10                
[146] GenomicRanges_1.46.1        car_3.1-1                   siggenes_1.68.0             broom_1.0.3                 org.Hs.eg.db_3.14.0        
[151] httr_1.4.5                  ggdendro_0.1.23             AnnotationDbi_1.56.2        colorspace_2.1-0            XML_3.99-0.13              
[156] fs_1.6.1                    IRanges_2.28.0              splines_4.1.3               RBGL_1.70.0                 multtest_2.50.0            
[161] plotly_4.10.1               xtable_1.8-4                jsonlite_1.8.4              R6_2.5.1                    RUnit_0.4.32               
[166] gsubfn_0.7                  pillar_1.8.1                htmltools_0.5.4             glue_1.6.2                  fastmap_1.1.1              
[171] BiocParallel_1.28.3         beanplot_1.3.1              codetools_0.2-18            utf8_1.2.3                  lattice_0.20-45            
[176] tibble_3.1.8                sqldf_0.4-11                curl_5.0.0                  gtools_3.9.4                GO.db_3.14.0               
[181] openssl_2.0.5               survival_3.3-1              rmarkdown_2.20              repr_1.1.6                  desc_1.4.2                 
[186] munsell_0.5.0               GetoptLong_1.0.5            rhdf5_2.38.1                GenomeInfoDbData_1.2.7      iterators_1.0.14           
[191] RCy3_2.14.2                 HDF5Array_1.22.1            reshape2_1.4.4              gtable_0.3.1               


